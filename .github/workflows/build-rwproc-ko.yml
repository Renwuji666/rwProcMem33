name: build-rwproc-ko

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            bc \
            bison \
            flex \
            libssl-dev \
            gcc-aarch64-linux-gnu \
            make \
            tar \
            unzip \
            xz-utils

      - name: setup proton-clang (zip)
        run: |
          PROTON_VER=20210522
          PROTON_ROOT=$HOME/proton-clang
          PROTON_DIR="$PROTON_ROOT/proton-clang-${PROTON_VER}"
          if [ ! -d "$PROTON_DIR" ]; then
            mkdir -p "$PROTON_ROOT"
            cd "$PROTON_ROOT"
            wget "https://github.com/kdrag0n/proton-clang/archive/refs/tags/${PROTON_VER}.zip" -O proton-clang.zip
            unzip -q proton-clang.zip
          fi
          echo "$PROTON_DIR/bin" >> $GITHUB_PATH

      - name: unpack kernel ABI
        run: |
          mkdir -p kernel_abi
          tar -xzf Kernel_MIUI_umi_ABI_ecee392d.tar.gz -C kernel_abi
          if [ ! -f kernel_abi/.config ]; then
            echo "kernel_abi/.config not found in ABI tar" >&2
            exit 1
          fi
          echo "KERNEL_ABI_DIR=$PWD/kernel_abi" >> $GITHUB_ENV

      - name: fetch kernel source (tarball)
        run: |
          KERNEL_COMMIT=ecee392d0468d054443b2e4d090add1ba4882c41
          curl -L -o kernel_src.tar.gz "https://github.com/Renwuji666/kernel_xiaomi_sm8250_mod/archive/${KERNEL_COMMIT}.tar.gz"
          tar -xzf kernel_src.tar.gz
          KERNEL_DIR="kernel_xiaomi_sm8250_mod-${KERNEL_COMMIT}"
          mv "$KERNEL_DIR" kernel_src_tools
          tar -xzf kernel_src.tar.gz
          mv "$KERNEL_DIR" kernel_src_clean
          echo "KERNEL_SRC_TOOLS=$PWD/kernel_src_tools" >> $GITHUB_ENV
          echo "KERNEL_SRC=$PWD/kernel_src_clean" >> $GITHUB_ENV

      - name: prepare tools source-tree .config
        run: |
          cp -f "$KERNEL_ABI_DIR/.config" "$KERNEL_SRC_TOOLS/.config"
          yes "" | make -C "$KERNEL_SRC_TOOLS" olddefconfig

      - name: build scripts (tools tree)
        run: |
          yes "" | make -C "$KERNEL_SRC_TOOLS" HOSTCC=gcc scripts
          mkdir -p "$KERNEL_ABI_DIR/scripts/basic" "$KERNEL_ABI_DIR/scripts/mod"
          cp -f "$KERNEL_SRC_TOOLS/scripts/basic/fixdep" "$KERNEL_ABI_DIR/scripts/basic/"
          cp -f "$KERNEL_SRC_TOOLS/scripts/mod/modpost" "$KERNEL_ABI_DIR/scripts/mod/"

      - name: build rwProcMem_module
        run: |
          MOD_DIR="$GITHUB_WORKSPACE/rwProcMem33Module/rwProcMem_module"
          OUT_DIR="$GITHUB_WORKSPACE/kernel_build"
          mkdir -p "$OUT_DIR"
          cp -f "$KERNEL_ABI_DIR/.config" "$OUT_DIR/.config"
          if [ -f "$KERNEL_ABI_DIR/Module.symvers" ]; then
            cp -f "$KERNEL_ABI_DIR/Module.symvers" "$OUT_DIR/Module.symvers"
          fi
          yes "" | make -C "$KERNEL_SRC" \
            O="$OUT_DIR" \
            KCONFIG_CONFIG="$OUT_DIR/.config" \
            ARCH=arm64 \
            CC=clang \
            LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            olddefconfig
          make -C "$KERNEL_SRC" \
            O="$OUT_DIR" \
            KCONFIG_CONFIG="$OUT_DIR/.config" \
            ARCH=arm64 \
            CC=clang \
            LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            modules_prepare
          make -C "$KERNEL_SRC" \
            O="$OUT_DIR" \
            KCONFIG_CONFIG="$OUT_DIR/.config" \
            ARCH=arm64 \
            CC=clang \
            LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            M="$MOD_DIR" \
            modules

      - name: collect artifacts
        run: |
          mkdir -p artifacts
          find rwProcMem33Module/rwProcMem_module -name "*.ko" -exec cp -v {} artifacts/ \;
          ls -la artifacts

      - name: upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rwProcMem_module-ko
          path: artifacts/*.ko
